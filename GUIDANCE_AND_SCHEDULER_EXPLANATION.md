# Guidance Scale 和 Scheduler 詳細解釋

## 1. Guidance Scale（引導強度）

### 什麼是 Guidance Scale？

**Guidance Scale**（也稱為 CFG Scale - Classifier-Free Guidance Scale）控制模型**遵循提示詞的嚴格程度**。

### 工作原理

Stable Diffusion 在生成圖片時會：
1. 同時考慮**有提示詞**的生成
2. 和**無提示詞**的生成
3. 然後根據 Guidance Scale 混合這兩者

```
最終結果 = 有提示詞的結果 + Guidance Scale × (有提示詞 - 無提示詞)
```

### 數值範圍和效果

| Guidance Scale | 效果 | 適用場景 | 問題 |
|----------------|------|----------|------|
| **1.0-3.0** | 非常創意，但可能偏離提示詞 | 藝術創作，探索性生成 | 可能不準確 |
| **4.0-6.0** | 創意與準確性平衡 | 需要一些變化的場景 | 可能不夠精確 |
| **7.0** | ✅ **標準值，最佳平衡** | **大多數場景（推薦）** | 無 |
| **8.0-10.0** | 嚴格遵循提示詞 | 需要精確匹配的場景 | 可能過度飽和 |
| **11.0-15.0** | 極度嚴格 | 特殊需求 | 可能產生偽影、過度飽和 |
| **20.0+** | 過度嚴格 | 不推薦 | 質量下降，偽影增多 |

### 視覺效果對比

```
Guidance = 3.0:  "一個農夫在田裡" → 可能生成抽象的藝術風格
Guidance = 7.0:  "一個農夫在田裡" → ✅ 準確的農夫在田裡
Guidance = 12.0: "一個農夫在田裡" → 過度飽和，顏色過於鮮豔，可能有偽影
```

### 實際例子

**低 Guidance (3.0):**
- 提示詞："農夫在田裡工作"
- 結果：可能是抽象的農夫形象，背景可能不符合

**標準 Guidance (7.0):** ✅
- 提示詞："農夫在田裡工作"
- 結果：準確的農夫在田裡工作的場景

**高 Guidance (12.0):**
- 提示詞："農夫在田裡工作"
- 結果：過度飽和，顏色過於鮮豔，可能有重複部分

### 為什麼我們使用 7.0？

- ✅ 準確遵循提示詞
- ✅ 保持自然的外觀
- ✅ 不會過度飽和
- ✅ 不會產生偽影
- ✅ 業界標準值

---

## 2. Scheduler（調度器）vs Steps（步數）

### ⚠️ 重要區別：Steps 和 Scheduler 是不同的！

**Steps (num_inference_steps) = 步數**
- **是什麼：** 模型執行多少次去噪迭代
- **作用：** 決定生成過程的"長度"
- **例子：** 20 steps = 模型執行 20 次去噪操作

**Scheduler = 調度器**
- **是什麼：** 決定每一步"如何"去噪的算法
- **作用：** 決定每一步的計算方式
- **例子：** DPM++ 2M Karras = 使用這種算法來執行每一步

### 類比理解

想像你在畫一幅畫：

**Steps（步數）：**
- 就像問："你要畫多少筆？"
- 20 steps = 畫 20 筆
- 10 steps = 畫 10 筆（更快但可能不夠細緻）

**Scheduler（調度器）：**
- 就像問："你用什麼畫筆和技巧？"
- DPM++ 2M Karras = 用高級畫筆，每筆都很精細
- Euler Ancestral = 用普通畫筆，每筆較快

### 兩者如何配合

```
Steps = 20, Scheduler = DPM++ 2M Karras
= 執行 20 次去噪，每次都用 DPM++ 2M Karras 算法

Steps = 20, Scheduler = Euler Ancestral  
= 執行 20 次去噪，每次都用 Euler Ancestral 算法
```

### 工作原理

圖片生成過程：
```
隨機噪聲 
  → [Step 1: 用 Scheduler 算法去噪] 
  → [Step 2: 用 Scheduler 算法去噪] 
  → ... 
  → [Step N: 用 Scheduler 算法去噪] 
  → 最終圖片
```

**Steps 決定：** 執行多少次（N = 多少步）
**Scheduler 決定：** 每一步用什麼算法

### Scheduler 決定：
- 每一步去除多少噪聲
- 每一步的"步長"大小
- 如何平衡速度和質量

### 常見 Scheduler 類型

#### 1. **DPM++ 2M Karras** ⭐ 推薦

**特點：**
- ✅ 高質量輸出
- ✅ 較少偽影
- ✅ 適合 15-25 步
- ✅ 業界標準高質量選擇

**適用場景：**
- 需要高質量的圖片
- 有足夠時間（20-50秒）
- 推薦用於故事插圖

**速度：** 中等（30-50秒，20步）

---

#### 2. **Euler Ancestral**

**特點：**
- ✅ 快速
- ✅ 質量良好
- ⚠️ 可能有一些隨機性

**適用場景：**
- 需要快速生成
- 可以接受一些變化

**速度：** 快（20-40秒，20步）

---

#### 3. **DDIM (Denoising Diffusion Implicit Models)**

**特點：**
- ✅ 穩定、可重現
- ✅ 質量好
- ❌ 較慢

**適用場景：**
- 需要完全可重現的結果
- 有充足時間

**速度：** 慢（50-80秒，20步）

---

#### 4. **LMS (Linear Multi-Step)**

**特點：**
- ✅ 平衡速度與質量
- ⚠️ 較少使用

**速度：** 中等

---

#### 5. **PNDM (Pseudo Numerical methods for Diffusion Models)**

**特點：**
- ✅ 穩定
- ⚠️ 較舊的方法

**速度：** 中等

---

### Scheduler 對比表

| Scheduler | 質量 | 速度 | 穩定性 | 推薦度 |
|-----------|------|------|--------|--------|
| **DPM++ 2M Karras** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ✅ **最推薦** |
| Euler Ancestral | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ✅ 快速選擇 |
| DDIM | ⭐⭐⭐⭐ | ⭐⭐ | ⭐⭐⭐⭐⭐ | 可選 |
| LMS | ⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐ | 較少使用 |
| PNDM | ⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐ | 較少使用 |

### 為什麼我們使用 DPM++ 2M Karras？

1. **高質量：** 產生的圖片細節豐富，偽影少
2. **平衡：** 速度與質量的最佳平衡
3. **穩定：** 結果一致，可預測
4. **業界標準：** 廣泛使用的高質量選擇
5. **適合故事插圖：** 能準確呈現場景描述

### Scheduler 如何影響生成？

**相同提示詞，不同 Scheduler：**

```
提示詞："農夫在田裡工作"

DPM++ 2M Karras:
→ 高質量，細節豐富，準確

Euler Ancestral:
→ 質量好，但可能有一些隨機變化

DDIM:
→ 穩定，但可能較慢
```

---

## 3. Steps、Scheduler 和 Guidance Scale 如何協同工作

### 完整組合效果

```
Guidance Scale = 7.0 
+ DPM++ 2M Karras Scheduler 
+ Steps = 20
= 準確遵循提示詞 + 高質量生成過程 + 適當的迭代次數
= ✅ 最佳平衡
```

### 實際配置示例

**當前最佳配置：**
```python
guidance_scale = 7.0          # 標準引導強度
scheduler = "DPM++ 2M Karras"  # 高質量調度器（決定每一步怎麼做）
num_steps = 20                 # 20步（決定做多少次）
```

**結果：**
- ✅ 準確遵循提示詞（Guidance 7.0）
- ✅ 高質量生成（DPM++ 2M Karras 算法）
- ✅ 適當的迭代次數（20步，不會太少也不會太多）
- ✅ 合理速度（30-50秒）

### 三者關係圖解

```
┌─────────────────────────────────────────┐
│        圖片生成過程                      │
├─────────────────────────────────────────┤
│                                          │
│  Steps = 20                              │
│  (執行 20 次迭代)                         │
│                                          │
│  ┌──────────────────────────────────┐  │
│  │ Step 1: 用 Scheduler 算法去噪     │  │
│  │ Step 2: 用 Scheduler 算法去噪     │  │
│  │ ...                               │  │
│  │ Step 20: 用 Scheduler 算法去噪    │  │
│  └──────────────────────────────────┘  │
│                                          │
│  每一步都受 Guidance Scale 影響          │
│  (決定遵循提示詞的強度)                   │
│                                          │
└─────────────────────────────────────────┘
```

### 不同組合的效果

| Steps | Scheduler | Guidance | 效果 |
|-------|-----------|----------|------|
| 10 | Euler Ancestral | 7.0 | 快速但質量一般 |
| **20** | **DPM++ 2M Karras** | **7.0** | **✅ 最佳平衡** |
| 20 | Euler Ancestral | 7.0 | 質量稍低但更快 |
| 30 | DPM++ 2M Karras | 7.0 | 質量好但可能偽影 |
| 20 | DPM++ 2M Karras | 12.0 | 過度飽和 |

---

## 4. 常見問題

### Q: 為什麼不提高 Guidance Scale 到 10+？

**A:** 過高的 Guidance Scale 會：
- 產生過度飽和的顏色
- 可能產生偽影和重複部分
- 圖片看起來不自然
- 7.0 已經足夠準確

### Q: 可以換成更快的 Scheduler 嗎？

**A:** 可以，但會犧牲質量：
- Euler Ancestral：更快，但質量稍低
- 如果時間緊迫，可以考慮
- 但 DPM++ 2M Karras 是推薦選擇

### Q: 為什麼不同 Scheduler 速度不同？

**A:** 因為它們的算法不同：
- 有些需要更多計算
- 有些更高效
- DPM++ 2M Karras 在質量和速度間平衡最好

### Q: Steps、Guidance Scale 和 Scheduler 哪個更重要？

**A:** 三者都重要，但作用不同：
- **Steps：** 控制迭代次數（太少=質量差，太多=可能偽影）
- **Guidance Scale：** 控制是否遵循提示詞（準確性）
- **Scheduler：** 控制每一步的算法（圖片質量）
- 三者配合使用效果最佳

### Q: Steps 和 Scheduler 有什麼關係？

**A:** 
- **Steps = 做多少次**
- **Scheduler = 怎麼做**
- 例如：20 steps + DPM++ 2M Karras = 用 DPM++ 2M Karras 算法執行 20 次
- 不同的 Scheduler 在相同步數下可能產生不同質量的結果

---

## 5. 調整建議

### 如果圖片不夠準確（偏離提示詞）

**解決方案：**
- 稍微提高 Guidance Scale：7.0 → 8.0
- 不要超過 9.0（會產生偽影）

### 如果圖片過度飽和或不自然

**解決方案：**
- 降低 Guidance Scale：7.0 → 6.0
- 檢查是否使用了過高的值

### 如果需要更快生成

**解決方案：**
- 使用 Euler Ancestral Scheduler
- 減少步數：20 → 15
- 注意：會稍微降低質量

### 如果需要最高質量

**解決方案：**
- 保持 DPM++ 2M Karras
- 保持 Guidance 7.0
- 可以稍微增加步數：20 → 25
- 注意：會增加生成時間

---

## 總結

### Guidance Scale（引導強度）
- **作用：** 控制遵循提示詞的嚴格程度
- **推薦值：** 7.0（標準平衡）
- **範圍：** 1.0-15.0（超過 10 不推薦）

### Scheduler（調度器）
- **作用：** 控制從噪聲到圖片的生成過程
- **推薦：** DPM++ 2M Karras（高質量）
- **替代：** Euler Ancestral（更快）

### 最佳組合
```
Guidance Scale = 7.0
Scheduler = DPM++ 2M Karras
Steps = 20
```

這組合提供：
- ✅ 準確的提示詞遵循
- ✅ 高質量的圖片生成
- ✅ 合理的生成速度（30-50秒）

